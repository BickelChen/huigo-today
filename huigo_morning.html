<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>輝哥的晨間啟動器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        /* 淺色模式載入動畫 */
        .loader {
            border: 4px solid #f3f4f6; /* bg-gray-100 */
            border-top: 4px solid #3b82f6; /* text-blue-500 */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 卡片淡入動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- 標題 -->
        <header class="mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-green-500 mb-2">
                輝哥的晨間啟動器V1-2025/11/12
            </h1>
            <p id="current-date" class="text-xl text-gray-500">正在載入日期...</p>
        </header>

        <!-- 網格佈局 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <!-- 卡片 1: 高雄天氣 (即時) -->
            <div id="weather-card" class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.1s;">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">高雄天氣 (即時)</h2>
                <div id="weather-content" class="min-h-[150px] flex items-center justify-center">
                    <div class="loader"></div>
                </div>
                <p id="weather-time" class="text-xs text-gray-400 text-right mt-4"></p>
            </div>

            <!-- 卡片 2: 今日吉凶 (傳送門) -->
            <div id="almanac-card" class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.2s;">
                <h2 id="almanac-title" class="text-xl font-semibold text-green-600 mb-4">今日吉凶 (傳送門)</h2>
                <div id="almanac-content" class="min-h-[150px] flex items-center justify-center">
                    <!-- Vibe Vibe: 靜態傳送門 Vibe -->
                    <a href="https://goodaytw.com/" target="_blank" rel="noopener noreferrer" class="w-full py-3 px-4 bg-green-600 text-white text-center rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-md">
                        查看 goodaytw.com
                    </a>
                </div>
            </div>

            <!-- 卡片 3: 歷史上的今天 -->
            <div id="history-card" class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.3s;">
                <h2 class="text-xl font-semibold text-purple-600 mb-4">歷史上的今天</h2>
                <div id="history-content" class="min-h-[150px] text-gray-700 text-sm overflow-y-auto max-h-[150px] flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- 卡片 4: CNA 科技新聞 -->
            <div id="news-card" class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.4s;">
                <h2 id="news-title" class="text-xl font-semibold text-red-600 mb-4">CNA 科技新聞</h2>
                <div id="news-content" class="min-h-[150px] flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>
            
            <!-- 卡片 5: 今日 Vibe -->
            <div id="vibe-card" class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.5s;">
                <h2 class="text-xl font-semibold text-cyan-600 mb-4">今日 Vibe</h2>
                <!-- 早安圖 -->
                <div id="vibe-image-content" class="min-h-[150px] flex items-center justify-center mb-4">
                    <div class="loader"></div>
                </div>
                <!-- 每日金句 -->
                <div id="vibe-quote-content" class="min-h-[50px] text-gray-700 text-sm italic flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- 卡片 6: 快速連結 -->
            <div class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.6s;">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">快速連結</h2>
                <div class="flex flex-col space-y-3">
                    <a href="mailto:" target="_blank" rel="noopener noreferrer" class="py-2 px-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">Email</a>
                    <a href="https://www.youtube.com" target="_blank" rel="noopener noreferrer" class="py-2 px-4 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">YouTube</a>
                    <a href="https://gemini.google.com/" target="_blank" rel="noopener noreferrer" class="py-2 px-4 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">Gemini</a>
                    <a href="https://chat.openai.com/" target="_blank" rel="noopener noreferrer" class="py-2 px-4 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">ChatGPT</a>
                    <a href="https://claude.ai/" target="_blank" rel="noopener noreferrer" class="py-2 px-4 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors">Claude</a>
                </div>
            </div>

            <!-- 卡片 7: 今日待辦 (Top 3) -->
            <div id="todo-card" class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.7s;">
                <h2 class="text-xl font-semibold text-orange-600 mb-4">今日待辦 (Top 3)</h2>
                <div class="space-y-3">
                    <div class="flex items-center">
                        <input type="checkbox" id="todo1" class="h-5 w-5 text-orange-500 rounded border-gray-300 focus:ring-orange-500">
                        <input type="text" placeholder="Vibe 1..." class="ml-3 flex-1 border-0 border-b-2 border-gray-200 focus:border-orange-500 focus:ring-0 p-1 bg-transparent">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="todo2" class="h-5 w-5 text-orange-500 rounded border-gray-300 focus:ring-orange-500">
                        <input type="text" placeholder="Vibe 2..." class="ml-3 flex-1 border-0 border-b-2 border-gray-200 focus:border-orange-500 focus:ring-0 p-1 bg-transparent">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="todo3" class="h-5 w-5 text-orange-500 rounded border-gray-300 focus:ring-orange-500">
                        <input type="text" placeholder="Vibe 3..." class="ml-3 flex-1 border-0 border-b-2 border-gray-200 focus:border-orange-500 focus:ring-0 p-1 bg-transparent">
                    </div>
                </div>
            </div>

            <!-- 卡片 8: 即時筆記 -->
            <div id="notes-card" class="card-fade-in bg-white p-5 rounded-xl shadow-lg" style="animation-delay: 0.8s;">
                <h2 class="text-xl font-semibold text-pink-600 mb-4">即時筆記</h2>
                <textarea class="w-full h-32 p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-pink-50/50" placeholder="Vibe 在這裡..."></textarea>
            </div>

        </div> <!-- end grid -->

    </div> <!-- end container -->

    <script>
        // --- Vibe: API 設定 ---
        // 環境會自動注入 API Key
        const apiKey = ""; 
        const apiUrlFlash = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const apiUrlImagen = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

        // 頁面載入時執行
        window.onload = () => {
            setCurrentDate();
            fetchWeather(); // (即時 RSS)
            // Vibe Vibe: 不再呼叫 fetchHoroscope()
            fetchTodayInHistory(); // (Gemini)
            fetchCnaNews(); // (即時 RSS + 後備 Vibe)
            fetchDailyImage(); // (Imagen)
            fetchDailyQuote(); // (Gemini)
        }

        // --- 1. 設定日期 ---
        function setCurrentDate() {
            const dateEl = document.getElementById('current-date');
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.textContent = now.toLocaleDateString('zh-TW', options);
        }

        // --- 2. 取得高雄天氣 (即時 RSS) ---
        async function fetchWeather() {
            const contentEl = document.getElementById('weather-content');
            const timeEl = document.getElementById('weather-time');
            const rssFeedUrl = 'https://www.cwa.gov.tw/rss/forecast/36_02.xml';
            const rss2jsonApi = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssFeedUrl)}`;

            try {
                const response = await fetch(rss2jsonApi);
                if (!response.ok) throw new Error(`RSS 轉換錯誤! ${response.status}`);
                const data = await response.json();
                if (data.status !== 'ok' || !data.items || data.items.length === 0) {
                    throw new Error('無法取得 RSS 資料');
                }

                // Vibe Vibe: 從 Title Vibe 資料
                const title = data.items[0].title;
                console.log("CWA RSS Raw Title:", title); // Vibe 抓蟲用

                // Vibe Vibe: 範例 "高雄市11/12 今日白天 陰短暫陣雨 溫度: 26 ~ 28 降雨機率: 70% (11/12 11:00發布)"
                const statusMatch = title.match(/今日白天\s+([^ ]+)\s+溫度/);
                const tempMatch = title.match(/溫度[\s:：]*([\d\s~～-]+)/);
                const rainMatch = title.match(/降雨機率[\s:：]*([\d]+)%/);
                const pubTimeMatch = title.match(/(\([\d/]+\s+[\d:]+發布\))/); // Vibe Vibe: 抓取標題中的發布時間

                const status = statusMatch ? statusMatch[1].trim() : 'N/A';
                const temp = tempMatch ? tempMatch[1].trim() : 'N/A';
                const rain = rainMatch ? rainMatch[1].trim() : 'N/A';
                
                // Vibe Vibe: 決定要顯示的時間
                const pubDate = new Date(data.items[0].pubDate).toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                const updateTime = pubTimeMatch ? pubTimeMatch[1] : pubDate; // 優先使用 Vibe 抓到的時間

                contentEl.innerHTML = `
                    <div class="text-center">
                        <p class="text-5xl font-bold">${temp}°C</p>
                        <p class="text-xl text-gray-600 mt-2">${status}</p>
                        <p class="text-md text-blue-500 mt-2">降雨機率: ${rain}%</p>
                    </div>
                `;
                timeEl.textContent = `資料更新: ${updateTime}`;

            } catch (error) {
                console.error('無法取得天氣:', error);
                contentEl.innerHTML = `<span class="text-sm text-red-500">無法載入天氣: ${error.message}</span>`;
                timeEl.textContent = '';
            }
        }

        // --- 3. Vibe Vibe: goodaytw.com 的 Vibe (靜態傳送門) ---
        // 我們不需要 fetchHoroscope() 了，因為 HTML 已經 Vibe 好了。


        // --- 4. 取得歷史上的今天 (Gemini) ---
        async function fetchTodayInHistory() {
            const contentEl = document.getElementById('history-content');
            const now = new Date();
            const todayString = `${now.getMonth() + 1}月${now.getDate()}日`;
            
            const prompt = `請用繁體中文，告訴我今天 (${todayString}) 歷史上發生的一件有趣或重要的事。請簡潔，並只回傳事件描述。`;

            try {
                const text = await callGemini(prompt);
                contentEl.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
                contentEl.classList.remove('flex', 'items-center', 'justify-center');
            } catch (error) {
                console.error('無法載入歷史事件:', error);
                contentEl.innerHTML = `<span class="text-sm text-red-500">無法載入歷史事件: ${error.message}</span>`;
            }
        }

        // --- 5. 取得 CNA 科技新聞 (即時 RSS) ---
        async function fetchCnaNews() {
            const contentEl = document.getElementById('news-content');
            const rssFeedUrl = 'https://feeds.feedburner.com/rsscna/technology';
            const rss2jsonApi = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssFeedUrl)}`;

            try {
                const response = await fetch(rss2jsonApi);
                if (!response.ok) throw new Error(`RSS 轉換錯誤! 狀態: ${response.status}`);
                const data = await response.json();
                if (data.status !== 'ok' || !data.items || data.items.length === 0) {
                    throw new Error('無法取得 RSS 資料');
                }

                // Vibe: 抓取最新的 4 則新聞
                const newsItems = data.items.slice(0, 4);
                
                // Vibe: 建立新聞列表
                contentEl.innerHTML = `
                    <ul class="space-y-3 text-sm text-gray-700">
                        ${newsItems.map(item => `
                            <li>
                                <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-500 hover:underline truncate block" title="${item.title}">
                                    - ${item.title}
                                </a>
                            </li>
                        `).join('')}
                    </ul>
                `;
                // Vibe Vibe: 修正排版
                contentEl.classList.remove('flex', 'items-center', 'justify-center');
                contentEl.classList.add('overflow-y-auto', 'max-h-[150px]');

            } catch (error) {
                console.error('無法取得 CNA 新聞:', error);
                // Vibe Vibe: 執行後備 Vibe！
                loadCteeFallback();
            }
        }
        
        // Vibe Vibe: CNA 新聞的後備 Vibe (靜態連結)
        function loadCteeFallback() {
            document.getElementById('news-title').textContent = "今日頭條 (CTEE)";
            const contentEl = document.getElementById('news-content');
            contentEl.innerHTML = `
                <a href="https://m.ctee.com.tw/cteenews" target="_blank" rel="noopener noreferrer" class="w-full py-3 px-4 bg-red-600 text-white text-center rounded-lg hover:bg-red-700 transition-colors font-semibold shadow-md">
                    前往 CTEE 工商時報
                </a>
            `;
        }


        // --- 6. 取得今日 Vibe (早安圖 + 金句) ---
        async function fetchDailyImage() {
            const contentEl = document.getElementById('vibe-image-content');
            const prompt = "一張充滿正能量、清新風格的早安圖，適合放在晨間儀表板上。例如日出、咖啡、或微笑。";
            
            try {
                const base64Image = await callImagen(prompt);
                contentEl.innerHTML = `<img src="data:image/png;base64,${base64Image}" alt="今日早安圖" class="rounded-lg object-cover w-full h-full max-h-[150px]">`;
            } catch (error) {
                console.error('無法產生早安圖:', error);
                contentEl.innerHTML = `<span class="text-sm text-red-500">無法產生早安圖: ${error.message}</span>`;
            }
        }

        async function fetchDailyQuote() {
            const contentEl = document.getElementById('vibe-quote-content');
            const prompt = "請用繁體中文，給我一句激勵人心的話，適合在新的一天開始時閱讀。請只回傳這句話，不要有其他文字。";
            
            try {
                const text = await callGemini(prompt);
                contentEl.innerHTML = `<p>"${text}"</p>`;
            } catch (error) {
                console.error('無法載入今日金句:', error);
                contentEl.innerHTML = `<span class="text-sm text-red-500">無法載入今日金句: ${error.message}</span>`;
            }
        }


        // --- Vibe: API 呼叫工具 ---

        // Vibe: 呼叫 Gemini (Flash)
        async function callGemini(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                // Vibe Vibe: 移除 generationConfig，使用預設值
            };
            const response = await fetchWithBackoff(apiUrlFlash, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            // Vibe Vibe: 增強錯誤 Vibe
            if (result.candidates && result.candidates.length > 0) {
                const candidate = result.candidates[0];
                if (candidate.content && candidate.content.parts && candidate.content.parts[0].text) {
                    return candidate.content.parts[0].text;
                }
                if (candidate.finishReason && candidate.finishReason !== "STOP") {
                    throw new Error(`Gemini API 提早結束: ${candidate.finishReason}`);
                }
            }
            
            // Vibe Vibe: 印出完整 Vibe 抓蟲
            console.error("Gemini API 格式錯誤，完整回應:", result);
            throw new Error('Gemini API 回應格式不符');
        }

        // Vibe: 呼叫 Imagen
        async function callImagen(prompt) {
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };
            const response = await fetchWithBackoff(apiUrlImagen, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                return result.predictions[0].bytesBase64Encoded;
            } else {
                console.error("Imagen API 格式錯誤，完整回應:", result);
                throw new Error('Imagen API 回應格式不符');
            }
        }

        // Vibe: 具備指數退避的 Fetch
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP 錯誤! 狀態: ${response.status} ${errorBody.substring(0, 100)}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    console.warn(`Fetch Vibe 失敗 (第 ${i + 1} 次): ${error.message}。 ${delay}ms 後重試...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // 指數退避
                }
            }
            throw new Error(`Fetch 失敗，已達最大重試次數: ${lastError.message}`);
        }

    </script>
</body>
</html>